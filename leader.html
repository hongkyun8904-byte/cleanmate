<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>íŒ€ì¥ í˜ì´ì§€ | CleanMate</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body{
      margin:0;
      padding:16px;
      background:#f5f7fb;
      font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",system-ui,sans-serif;
      color:#222;
    }
    h1{
      font-size:20px;
      margin-bottom:12px;
    }
    .card{
      background:#fff;
      border-radius:14px;
      padding:14px;
      margin-bottom:12px;
      box-shadow:0 6px 18px rgba(0,0,0,0.06);
      font-size:13px;
    }
    .btn{
      width:100%;
      padding:10px;
      margin-top:6px;
      border:none;
      border-radius:999px;
      font-size:13px;
      font-weight:700;
      cursor:pointer;
    }
    .btn-blue{ background:#0288d1;color:#fff; }
    .btn-red{ background:#c62828;color:#fff; }
    .btn-gray{ background:#e0e0e0;color:#333; }

    input[type="file"]{
      width:100%;
      margin-top:6px;
    }
  </style>
</head>
<body>

<h1>ğŸ§‘â€ğŸ”§ íŒ€ì¥ í˜ì´ì§€</h1>

<div id="orderList">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

<script>
/* ===============================
   1ï¸âƒ£ Supabase ì—°ê²°
   =============================== */
const SUPABASE_URL = "https://nuchpyxjyqcpldpnffhu.supabase.co";
const SUPABASE_KEY = "sb_publishable_edX6Oi2eo5A5MjYYo323Fg_6ESnzQmL";

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_KEY
);

/* ===============================
   2ï¸âƒ£ íŒ€ì¥ ì†Œì† ì—…ì²´ (ì§€ê¸ˆì€ ê³ ì •)
   =============================== */
const COMPANY_NAME = "í™˜ìŠ¹í´ë¦°";

/* ===============================
   3ï¸âƒ£ ì£¼ë¬¸ ë¶ˆëŸ¬ì˜¤ê¸°
   =============================== */
async function loadOrders(){
  const box = document.getElementById("orderList");
  box.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

  const { data, error } = await supabaseClient
    .from("orders")
    .select("*")
    .eq("assigned_company", COMPANY_NAME)
    .order("created_at", { ascending:false });

  if(error){
    box.innerHTML = "ì£¼ë¬¸ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
    console.error(error);
    return;
  }

  if(!data || data.length === 0){
    box.innerHTML = "ë°°ì •ëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.";
    return;
  }

  box.innerHTML = data.map(o => `
    <div class="card">
      <b>${o.name}</b> (${o.phone})<br>
      ì£¼ì†Œ: ${o.address || "-"}<br>
      ìƒíƒœ: <b>${o.status}</b><br>
      ì²­ì†Œì¼: ${o.clean_date || "-"} / ${o.clean_time || "-"}

      <input type="file" multiple />

      <button class="btn btn-blue"
        onclick="requestExtra('${o.id}')">
        ğŸ’° ì¶”ê°€ê¸ˆ ìš”ì²­
      </button>

      <button class="btn btn-red"
        onclick="requestExit('${o.id}')">
        âŒ í‡´ê±° ì²˜ë¦¬
      </button>
    </div>
  `).join("");
}

/* ===============================
   4ï¸âƒ£ ì¶”ê°€ê¸ˆ ìš”ì²­
   =============================== */
async function requestExtra(orderId){
  const amount = prompt("ì¶”ê°€ê¸ˆ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš” (ìˆ«ìë§Œ)");

  if(!amount) return;

  const { error } = await supabaseClient
    .from("orders")
    .update({
      extra_charge: Number(amount),
      payment_status: "extra_requested"
    })
    .eq("id", orderId);

  if(error){
    alert("ì¶”ê°€ê¸ˆ ìš”ì²­ ì‹¤íŒ¨");
    console.error(error);
    return;
  }

  alert("ì¶”ê°€ê¸ˆ ìš”ì²­ ì™„ë£Œ");
}

/* ===============================
   5ï¸âƒ£ í‡´ê±° ì²˜ë¦¬
   =============================== */
async function requestExit(orderId){
  if(!confirm("ì •ë§ í‡´ê±° ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê¸ˆì•¡ 50% ì •ì‚°)")) return;

  const { error } = await supabaseClient
    .from("orders")
    .update({
      status: "í‡´ê±°",
      payment_status: "exit_required"
    })
    .eq("id", orderId);

  if(error){
    alert("í‡´ê±° ì²˜ë¦¬ ì‹¤íŒ¨");
    console.error(error);
    return;
  }

  alert("í‡´ê±° ì²˜ë¦¬ ì™„ë£Œ");
  loadOrders();
}

/* ===============================
   ì´ˆê¸° ì‹¤í–‰
   =============================== */
loadOrders();
</script>

</body>
</html>
