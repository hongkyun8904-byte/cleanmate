<script>
const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");

if (pw !== "ghkstmdzmffls8904!") {
  alert("ì ‘ê·¼ ë¶ˆê°€");
  location.href = "index.html";
} else {
  window.addEventListener("DOMContentLoaded", () => {
    openAdminDashboard();
  });
}

function openAdminDashboard() {
  const admin = document.getElementById("adminDashboard");
  if (!admin) return;

  admin.style.display = "block";

  // ğŸ”¥ğŸ”¥ğŸ”¥ ì´ 4ì¤„ì´ ìƒëª…
  loadAdminStats();
  loadOrders();
  loadCustomers();
  loadAdminReviews();
}
</script>
<body>
<!-- ===============================
     ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ (ìˆ¨ê¹€)
     =============================== -->
<div id="adminDashboard" style="
  display:none;
  position:fixed;
  inset:0;
  background:#f5f7fb;
  z-index:9998;
  overflow:auto;
">
  <div style="max-width:1200px;margin:20px auto;padding:20px;">

  <!-- ê´€ë¦¬ì ì œëª© -->
  <div style="
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding-bottom:12px;
    border-bottom:1px solid #ddd;
  ">
    <div>
      <h2 style="margin:0;">CleanMate ê´€ë¦¬ì</h2>
      <div style="font-size:12px;color:#666;">
        ê²¬ì  Â· ê³ ê° Â· ì—…ì²´ Â· ë¦¬ë·° í†µí•© ê´€ë¦¬
      </div>
    </div>
    <button onclick="closeAdminDashboard()"
      style="padding:8px 14px;border-radius:8px;border:1px solid #ccc;">
      ë‹«ê¸°
    </button>
  </div>

  <!-- ğŸ”¥ í†µê³„ ì¹´ë“œ (ì—¬ê¸°ê°€ í•µì‹¬) -->
  <div id="adminStats" style="
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:12px;
    margin:16px 0 20px;
  ">
    <div style="background:#fff;border-radius:14px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06);">
      <b>ëˆ„ì  ê²¬ì  ìš”ì²­</b><br>
      <span id="statTotalOrders">-</span> ê±´
    </div>

    <div style="background:#fff;border-radius:14px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06);">
      <b>ì‹¤ì œ ê³ ê° ìˆ˜</b><br>
      <span id="statCustomers">-</span> ëª…
    </div>

    <div style="background:#fff;border-radius:14px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06);">
      <b>ì‹¤ì œ ë°°ì • ì™„ë£Œ ê±´</b><br>
      <span id="statCompleted">-</span> ê±´
    </div>

    <div style="background:#fff;border-radius:14px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06);">
      <b>í‰ê·  ê°ë‹¨ê°€</b><br>
      <span id="statAvgPrice">-</span> ì›
    </div>

    <div style="background:#fff;border-radius:14px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06);">
      <b>ê³ ë¶€ê°€ íŠ¹ìˆ˜ì²­ì†Œ ë¹„ì¤‘</b><br>
      <span id="statSpecial">-</span> ê±´
    </div>
  </div>

  <!-- ê´€ë¦¬ì íƒ­ ë²„íŠ¼ -->
  <div style="margin-top:20px;display:flex;gap:12px;">
    <button onclick="showAdminTab('reviews')">â­ ë¦¬ë·° ê´€ë¦¬</button>
    <button onclick="showAdminTab('companies')">ğŸ¢ ì—…ì²´ ê´€ë¦¬</button>
    <button onclick="showAdminTab('customers')">ğŸ‘¤ ê³ ê° ê´€ë¦¬</button>
    <button onclick="showAdminTab('orders')">ğŸ“‹ ì˜ˆì•½ ê´€ë¦¬</button>
  </div>

  <!-- íƒ­ ì½˜í…ì¸  -->
  <div id="adminContent" style="margin-top:20px;"></div>

</div>
</div>

<script>
const ORDER_STEPS = [
  "ì ‘ìˆ˜ë¨",
  "ë°°ì •ì™„ë£Œ",
  "ë°˜ë ¤ë¨"
];

let customers = [];

function renderStatusFlow(currentStatus) {
  const currentIndex = ORDER_STEPS.indexOf(currentStatus);

  return `
    <div style="display:flex;gap:6px;margin-top:8px;">
      ${ORDER_STEPS.map((step, idx) => {
        let bg = "#eee";
        let color = "#999";

        if (idx < currentIndex) {
          bg = "#e3f2fd";     // ì™„ë£Œ(ì§€ë‚˜ê°„ ë‹¨ê³„)
          color = "#1565c0";
        } else if (idx === currentIndex) {
          bg = "#0288d1";     // í˜„ì¬ ë‹¨ê³„
          color = "#fff";
        }

        return `
          <div style="
            flex:1;
            text-align:center;
            padding:6px 0;
            border-radius:999px;
            font-size:11px;
            font-weight:600;
            background:${bg};
            color:${color};
          ">
            ${step}
          </div>
        `;
      }).join("")}
    </div>
  `;
}

/* ===============================
   ê³ ê° ë°ì´í„° (ê´€ë¦¬ì ì „ìš©)
   =============================== */

function updateApplyButtonText() {
  const isSpecial = document.getElementById("specialClean").checked;
  const btn = document.getElementById("applyBtn");

  if (!btn) return;

  if (isSpecial) {
    btn.textContent = "íŠ¹ìˆ˜ì²­ì†Œ ìƒë‹´ ì‹ ì²­í•˜ê¸°";
  } else {
    btn.textContent = "ìš°ìˆ˜ì—…ì²´ì—ê²Œ ìë™ ì‹ ì²­í•˜ê¸°";
  }
}

  function formatPrice(num) {
    if (num === 0) return "0ì›";
    if (!num) return "-";
    return num.toLocaleString("ko-KR") + "ì›";
  }

  function scrollToEstimate() {
    const el = document.getElementById("estimate-section");
    if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
  }

/* âœ… ë©”ì¸ ì„¹ì…˜ íƒ­ ì „í™˜ */
function showMainSection(type){

  // 1ï¸âƒ£ ì „ë¶€ ìˆ¨ê¹€
  document.getElementById("estimate-section").style.display = "none";
  document.getElementById("review-section").style.display = "none";
  document.getElementById("gallery-section").style.display = "none";

  // 2ï¸âƒ£ ë²„íŠ¼ active ì œê±°
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.classList.remove("active");
  });

  // 3ï¸âƒ£ ì„ íƒí•œ ê²ƒë§Œ ë³´ì—¬ì£¼ê¸°
  if(type === "estimate"){
    document.getElementById("estimate-section").style.display = "block";
    document.querySelectorAll(".tab-btn")[0].classList.add("active");
  }

  if(type === "review"){
    document.getElementById("review-section").style.display = "block";
    document.querySelectorAll(".tab-btn")[1].classList.add("active");
  }

  if(type === "gallery"){
    document.getElementById("gallery-section").style.display = "block";
    document.querySelectorAll(".tab-btn")[2].classList.add("active");
  }
}

/* âœ… ì²˜ìŒ í™”ë©´ì€ ê²¬ì ë§Œ */
document.addEventListener("DOMContentLoaded", () => {
  showMainSection("estimate");
});
function goMyPage() {
  window.location.href = "mypage.html";
}
 function updateCounter(type, delta) {
  let id = "";

  if (type === "ward2") id = "ward2Count";
  if (type === "ward3") id = "ward3Count";
  if (type === "aircon") id = "airconCount";
  if (type === "washer") id = "washerCount";
  if (type === "fridge") id = "fridgeCount";

  const el = document.getElementById(id);
  if (!el) return;

  let val = parseInt(el.textContent || "0", 10);
  val += delta;
  if (val < 0) val = 0;
  el.textContent = String(val);
}

  function calculateEstimate() {
    const structure = document.getElementById("structure").value;
    const supplyArea = parseFloat(document.getElementById("supplyArea").value || "0");
    const isUnexpanded = document.getElementById("isUnexpanded").checked;
    const loftArea = parseFloat(document.getElementById("loftArea").value || "0");
    const isLiveIn = document.getElementById("isLiveIn").checked;
    const ward2Count = parseInt(document.getElementById("ward2Count").textContent || "0", 10);
    const ward3Count = parseInt(document.getElementById("ward3Count").textContent || "0", 10);
    const kitchenDeep = document.getElementById("kitchenDeep").checked;
const sideClean = document.getElementById("sideClean").checked;
const specialClean = document.getElementById("specialClean").checked;
const specialNotice = document.getElementById("specialNotice");
updateApplyButtonText();

    // ì‚¬ì§„ ìˆ˜ & ëœë¤ ì˜¤ì—¼ë„
    const files = document.getElementById("photoInput").files;
    const photoCount = files.length;
    let scores = [];

    if (photoCount > 0) {
      for (let i = 0; i < photoCount; i++) {
        // 40~95 ì‚¬ì´ ëœë¤ (í˜„ì¬ëŠ” ìƒ˜í”Œìš©)
        const score = Math.floor(40 + Math.random() * 56);
        scores.push(score);
      }
    }

    const avgScore = scores.length
      ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length)
      : null;
    const maxScore = scores.length ? Math.max(...scores) : null;

    // 1) ê¸°ë³¸ê°€
    let basePrice = 0;
    if (structure === "ì›ë£¸") {
      basePrice = 160000;
    } else {
      if (supplyArea <= 0) {
        basePrice = 0;
      } else if (supplyArea <= 22) {
        basePrice = 220000;
      } else {
        basePrice = supplyArea * 10000;
      }
    }

    // 2) ë¹„í™•ì¥ + ë³µì¸µ
    const unexpAdd = isUnexpanded ? 50000 : 0;
    const loftAdd = loftArea > 0 ? loftArea * 5000 : 0;

    // 3) ê±°ì£¼ / ë¶™ë°•ì´ / ì£¼ë°©
    let optionsAdd = 0;
    const airconCount = parseInt(document.getElementById("airconCount").textContent || "0", 10);
const washerCount = parseInt(document.getElementById("washerCount").textContent || "0", 10);
const fridgeCount = parseInt(document.getElementById("fridgeCount").textContent || "0", 10);
const largeFridge = document.getElementById("largeFridge").checked;

optionsAdd += airconCount * 20000;
optionsAdd += washerCount * 20000;
optionsAdd += fridgeCount * 20000;

if (largeFridge && fridgeCount > 0) {
  optionsAdd += fridgeCount * 10000;
}
if (sideClean) optionsAdd += 50000;
    if (isLiveIn) optionsAdd += 50000;
    optionsAdd += ward2Count * 50000;
    optionsAdd += ward3Count * 70000;
    if (kitchenDeep) optionsAdd += 70000;

    // 4) ì‚¬ì§„ë³„ ì˜¤ì—¼ë„ ì¶”ê°€ìš”ê¸ˆ (ë³´í†µ ë”ëŸ¬ì›€ 0ì›)
    //    0~60 : 0ì›
    //    61~75 : +10,000ì›
    //    76~90 : +30,000ì›
    //    91~100: +50,000ì›
    let photoExtraTotal = 0;
    let detailRowsHtml = "";

    if (scores.length) {
      scores.forEach((score, idx) => {
        let extra = 0;
        let level = "ë³´í†µ";
        if (score > 60 && score <= 75) {
          extra = 10000;
          level = "ì•½ê°„ ë†’ìŒ";
        } else if (score > 75 && score <= 90) {
          extra = 30000;
          level = "ë†’ìŒ";
        } else if (score > 90) {
          extra = 50000;
          level = "ë§¤ìš° ë†’ìŒ";
        }
        photoExtraTotal += extra;

        detailRowsHtml += `
          <tr>
            <td>${idx + 1}ë²ˆ</td>
            <td>${score}ì </td>
            <td>${level}</td>
            <td>${extra ? "+" + extra.toLocaleString("ko-KR") + "ì›" : "0ì›"}</td>
          </tr>
        `;
      });
    } else {
      detailRowsHtml = `
        <tr>
          <td colspan="4" style="padding:10px 4px;font-size:11px;color:#8a94a6;">
            ì‚¬ì§„ì„ ì—…ë¡œë“œí•œ ê²½ìš°, ê° ì‚¬ì§„ë³„ ì˜¤ì—¼ë„ì™€ ì¶”ê°€ìš”ê¸ˆì´ í‘œì‹œë©ë‹ˆë‹¤.
          </td>
        </tr>
      `;
    }

    const total = basePrice + unexpAdd + loftAdd + optionsAdd + photoExtraTotal;

    // í™”ë©´ ë°˜ì˜
    document.getElementById("photoCountText").textContent = photoCount + "ì¥";
    document.getElementById("avgScoreText").textContent = avgScore !== null ? avgScore : "-";
    document.getElementById("maxScoreText").textContent = maxScore !== null ? maxScore : "-";

    document.getElementById("basePriceCell").textContent = formatPrice(basePrice);
    document.getElementById("unexpCell").textContent = formatPrice(unexpAdd);
    document.getElementById("loftCell").textContent = formatPrice(loftAdd);
    document.getElementById("optionsCell").textContent = formatPrice(optionsAdd);
    document.getElementById("photoExtraCell").textContent = formatPrice(photoExtraTotal);
    if (specialClean) {
  document.getElementById("totalPriceText").textContent = "ìƒë‹´ í›„ ê²°ì •";
  specialNotice.style.display = "block";
} else {
  document.getElementById("totalPriceText").textContent = formatPrice(total);
  specialNotice.style.display = "none";
}

    const tbody = document.querySelector("#photoDetailTable tbody");
    tbody.innerHTML = detailRowsHtml;

    // ê³„ì‚° í›„ ì‹ ì²­ ë°•ìŠ¤ ì˜¤í”ˆ
    document.getElementById("requestBox").style.display = "block";
  }

async function sendToKakao() {
  const specialClean = document.getElementById("specialClean").checked;

  const name = (document.getElementById("custName").value || "").trim();
  const phone = (document.getElementById("custPhone").value || "").trim();
  const addr = (document.getElementById("custAddr").value || "").trim();
  const memo = (document.getElementById("custMemo").value || "").trim();
  const cleanDate = document.getElementById("cleanDate").value;

let cleanTime = "";
const timeMorning = document.getElementById("timeMorning").checked;
const timeAfternoon = document.getElementById("timeAfternoon").checked;

if (timeMorning) cleanTime = "ì˜¤ì „ 8ì‹œ~9ì‹œ";
if (timeAfternoon) cleanTime = "ì˜¤í›„ 2ì‹œ~3ì‹œ";

const sideCleanChecked = document.getElementById("sideClean").checked;
let sideCleanTime = "";

if (sideCleanChecked) {
  const start = document.getElementById("sideStartTime").value;
  const end = document.getElementById("sideEndTime").value;
  sideCleanTime = start && end ? `${start} ~ ${end}` : "";
}

  if (!name || !phone) {
    alert("ì´ë¦„ê³¼ ì—°ë½ì²˜ëŠ” í•„ìˆ˜ ì…ë ¥ì…ë‹ˆë‹¤.");
    return;
  }

  /* ===============================
     1ï¸âƒ£ ê³ ê° upsert (Supabase)
     =============================== */
const { data: customerData, error: customerError } =
  await supabaseClient
    .from("customers")
    .upsert(
      {
        name,
        phone,
        address: addr,
        memo,
      },
      { onConflict: "phone" }
    )
    .select()
    .single();
console.log("customerData:", customerData);
console.log("customerError:", customerError);
if (customerError) {
  console.error(customerError);
  alert("ê³ ê° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  return;
}

  /* ===============================
     2ï¸âƒ£ ì£¼ë¬¸ ì €ì¥ (ê³ ê° ì—°ê²°)
     =============================== */
  const structure = document.getElementById("structure").value;
  const supplyAreaInput = document.getElementById("supplyArea").value;
const supplyArea = supplyAreaInput ? Number(supplyAreaInput) : null;
  const totalPrice = document.getElementById("totalPriceText").textContent || "-";
  const priceText = totalPrice;
const priceNumber = priceText.includes("ì›")
  ? parseInt(priceText.replace(/[^\d]/g, ""), 10)
  : null;
 
  const photoCountText = document.getElementById("photoCountText").textContent || "-";
  const avgScoreText = document.getElementById("avgScoreText").textContent || "-";
  const maxScoreText = document.getElementById("maxScoreText").textContent || "-";

const { data: orderData, error: orderError } = await supabaseClient
  .from("orders")
  .insert([{
    name,
    phone,
    address: addr,
    memo,
    structure,
    supply_area: supplyArea,
    estimated_price_text: totalPrice,
    estimated_price_number: priceNumber,
    clean_date: cleanDate,
    clean_time: cleanTime,
    side_clean_time: sideCleanTime || null,
    status: "ì ‘ìˆ˜ë¨"
  }])
  .select()
  .single();
  sessionStorage.setItem("order_id", orderData.id);

if (orderError) {
  console.error(orderError);
  alert("ì˜ˆì•½ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  return;
}

  const payload = {
  name,
  phone,
  address: addr,
  memo,
  clean_date: cleanDate,
  clean_time: cleanTime,
  side_clean_time: sideCleanTime || null,
  structure,
  supply_area: supplyArea,
  total_price_text: document.getElementById("totalPriceText").textContent
};

localStorage.setItem("cleanmate_payload", JSON.stringify(payload));

// í•„ìˆ˜ í™•ì¸ í˜ì´ì§€ë¡œ ì´ë™
window.location.href = "confirm.html";
  
}
  
</script>

<script>

/* ===============================
   ì—…ì²´ ë°ì´í„° (ê´€ë¦¬ì ì „ìš©)
   =============================== */

/* ===============================
   ë¦¬ë·° ë°ì´í„° (ê´€ë¦¬ì ì „ìš©)
   =============================== */
  let reviews = [];
  let adminReviews = [];
let publicReviews = [];
  async function loadAdminReviews() {
  const { data, error } = await supabaseClient
    .from("reviews")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    console.error(error);
    alert("ë¦¬ë·° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
    return;
  }

  adminReviews = data || [];
  renderReviews();
}

async function loadPublicReviews() {
  const { data, error } = await supabaseClient
    .from("reviews")
    .select("*")
    .eq("visible", true)
    .order("created_at", { ascending: false });

  if (error) {
    console.error(error);
    return;
  }

  publicReviews = data || [];
  renderPublicReviews();
  renderBAGallery();
}
  
let adminReviewScore = null;

function selectAdminReviewScore(score){
  adminReviewScore = score;
  alert(
    score === 5 ? "ë„ˆë¬´ ë§Œì¡±í•´ìš” ì„ íƒë¨" :
    score === 4 ? "ë§Œì¡±í•´ìš” ì„ íƒë¨" :
    "ì•„ì‰¬ì›Œìš” ì„ íƒë¨"
  );
}

function checkAdminReviewPhotos(){
  const input = document.getElementById("reviewPhotos");
  if (!input) return;

  if (input.files.length > 10) {
    alert("ì‚¬ì§„ì€ ìµœëŒ€ 10ì¥ê¹Œì§€ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
    input.value = "";
  }
}


/* ===============================
   ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ì œì–´
   =============================== */

function closeAdminDashboard() {
  document.getElementById("adminDashboard").style.display = "none";
}
/* ===============================
   ê´€ë¦¬ì ì£¼ë¬¸ ê´€ë¦¬
   =============================== */
  async function loadAdminStats() {
  // 1ï¸âƒ£ ì „ì²´ ì£¼ë¬¸ ìˆ˜
  const { count: totalOrders } = await supabaseClient
    .from("orders")
    .select("*", { count: "exact", head: true });

  // 2ï¸âƒ£ ê³ ê° ìˆ˜
  const { count: totalCustomers } = await supabaseClient
    .from("customers")
    .select("*", { count: "exact", head: true });

  // 3ï¸âƒ£ ë°°ì • ì™„ë£Œ ì£¼ë¬¸
  const { count: completedOrders } = await supabaseClient
    .from("orders")
    .select("*", { count: "exact", head: true })
    .eq("status", "ë°°ì •ì™„ë£Œ");
    
// 4ï¸âƒ£ í‰ê·  ê°ë‹¨ê°€ 
const { data: priceData, error: priceError } =
  await supabaseClient
    .from("orders")
    .select("estimated_price_number")
    .not("estimated_price_number", "is", null);

let avgPrice = "-";

if (!priceError && priceData.length > 0) {
  const sum = priceData.reduce(
    (acc, cur) => acc + cur.estimated_price_number,
    0
  );
  avgPrice = Math.round(sum / priceData.length).toLocaleString("ko-KR");
}

// 5ï¸âƒ£ íŠ¹ìˆ˜ì²­ì†Œ ë¹„ì¤‘ 
const specialCount = "-";

  // í™”ë©´ ë°˜ì˜
  document.getElementById("statTotalOrders").textContent = totalOrders ?? "-";
  document.getElementById("statCustomers").textContent = totalCustomers ?? "-";
  document.getElementById("statCompleted").textContent = completedOrders ?? "-";
  document.getElementById("statAvgPrice").textContent = avgPrice;
  document.getElementById("statSpecial").textContent = specialCount ?? "-";
}
  async function loadCustomers() {
  // 1ï¸âƒ£ ê³ ê° ëª©ë¡
  const { data: customerData, error: customerError } =
    await supabaseClient
      .from("customers")
      .select("*")
      .order("created_at", { ascending: false });

  if (customerError) {
    console.error(customerError);
    return;
  }

  // 2ï¸âƒ£ ì£¼ë¬¸ ëª©ë¡ (ì´ìš© íšŸìˆ˜ ê³„ì‚°ìš©)
  const { data: orderData, error: orderError } =
    await supabaseClient
      .from("orders")
      .select("phone");

  if (orderError) {
    console.error(orderError);
    return;
  }

  // 3ï¸âƒ£ ì „í™”ë²ˆí˜¸ë³„ ì´ìš© íšŸìˆ˜ ê³„ì‚°
  const orderCountMap = {};
  orderData.forEach(o => {
    if (!o.phone) return;
    orderCountMap[o.phone] = (orderCountMap[o.phone] || 0) + 1;
  });

  // 4ï¸âƒ£ ê³ ê° + ì´ìš©íšŸìˆ˜ í•©ì¹˜ê¸°
  customers = customerData.map(c => ({
    id: c.id,
    name: c.name,
    phone: c.phone,
    address: c.address,
    memo: c.memo || "",
    count: orderCountMap[c.phone] || 0
  }));

  renderCustomers();
}
  async function updateOrderStatus(orderId, newStatus) {
  let updateData = {};

  if (newStatus === "ì…ê¸ˆí™•ì¸") {

    // 1ï¸âƒ£ í™œì„±í™”ëœ ì—…ì²´ 1ê³³ ê°€ì ¸ì˜¤ê¸°
    const { data: companies, error } = await supabaseClient
      .from("companies")
      .select("company_name")
      .eq("is_active", true)
      .limit(1);

    if (error || !companies || companies.length === 0) {
      alert("í™œì„±í™”ëœ ì—…ì²´ê°€ ì—†ìŠµë‹ˆë‹¤");
      return;
    }

    // 2ï¸âƒ£ ì²« ë²ˆì§¸ ì—…ì²´ ë°°ì •
    updateData.status = "ë°°ì •ì™„ë£Œ";
    updateData.assigned_company = companies[0].company_name;

  } else {
    updateData.status = newStatus;
  }

  const { error: updateError } = await supabaseClient
    .from("orders")
    .update(updateData)
    .eq("id", orderId);

  if (updateError) {
    alert("ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨");
    console.error(updateError);
    return;
  }

  loadOrders();
}

  function renderNextActionButtons(order) {

  if (order.status === "ë°˜ë ¤ë¨") {
    return `
      <span style="font-size:12px;color:#c62828;font-weight:600;">
        ê³ ê° ë°˜ë ¤ë¨
      </span>
      <button
        style="margin-left:6px;color:#c62828;"
        onclick="deleteOrder('${order.id}')"
      >
        âŒ ì‚­ì œ
      </button>
    `;
  }

  let buttons = "";

  if (order.status === "ì ‘ìˆ˜ë¨") {
    buttons += `
      <button onclick="updateOrderStatus('${order.id}', 'ì…ê¸ˆí™•ì¸')">
        ğŸ’° ì…ê¸ˆí™•ì¸
      </button>
      <button onclick="rejectOrder('${order.id}')">
        â†© ê³ ê°ë°˜ë ¤
      </button>
    `;
  }


  buttons += `
    <button
      style="color:#c62828;"
      onclick="deleteOrder('${order.id}')"
    >
      âŒ ì‚­ì œ
    </button>
  `;

  return buttons;
}
  async function rejectOrder(orderId) {
  const reason = prompt(
    "ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”.\nì˜ˆ: ì „í™”ë²ˆí˜¸ ì˜¤ë¥˜ / ì£¼ì†Œ ë¶ˆëª…í™•"
  );

  if (!reason) return;

  const { error } = await supabaseClient
    .from("orders")
    .update({
      status: "ë°˜ë ¤ë¨",
      memo: reason
    })
    .eq("id", orderId);

  if (error) {
    alert("ë°˜ë ¤ ì²˜ë¦¬ ì‹¤íŒ¨");
    console.error(error);
    return;
  }

  loadOrders();
}

async function deleteOrder(orderId) {
  if (!confirm("ì´ ì˜ˆì•½ì„ ì™„ì „íˆ ì‚­ì œí• ê¹Œìš”?\n(ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)")) {
    return;
  }

  const { error } = await supabaseClient
    .from("orders")
    .delete()
    .eq("id", orderId);

  if (error) {
    alert("ì‚­ì œ ì‹¤íŒ¨");
    console.error(error);
    return;
  }

  loadOrders();
}

async function loadOrders() {
  const list = document.getElementById("orderList");
  if (!list) return;

  list.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

  const { data, error } = await supabaseClient
    .from("orders")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    list.innerHTML = "ì˜ˆì•½ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
    console.error(error);
    return;
  }

  if (!data || data.length === 0) {
    list.innerHTML = "ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.";
    return;
  }

  list.innerHTML = data.map(order => `
  <div style="
    background:#fff;
    border-radius:12px;
    padding:14px;
    margin-bottom:12px;
    box-shadow:0 6px 18px rgba(0,0,0,0.06);
    font-size:13px;
  ">
    <div style="font-weight:700;">
      ${order.name} (${order.phone})
    </div>
<button
  style="
    margin-top:6px;
    padding:6px 10px;
    border-radius:6px;
    border:1px solid #0288d1;
    background:#fff;
    color:#0288d1;
    font-size:12px;
    cursor:pointer;
    font-weight:600;
  "
  onclick="
    window.selectedOrderId='${order.id}';
    document.getElementById('selectedOrderInfo').innerText =
      'ì„ íƒëœ ì£¼ë¬¸: ${order.name} (${order.phone})';
      <button
  onclick="addReview()"
  id="addReviewBtn"
>
  ë¦¬ë·° ì¶”ê°€
</button>
  "
>
  ğŸ“ ë¦¬ë·° ì„ íƒ
</button>

<div style="margin-top:6px;color:#555;">
  ì£¼ì†Œ: ${order.address || "-"}<br>
  êµ¬ì¡°/í‰ìˆ˜: ${order.structure || "-"} / ${order.supply_area ?? "-"}í‰<br>
  ìƒíƒœ: <b>${order.status}</b><br>
  ì²­ì†Œì¼: ${order.clean_date || "-"}<br>
ì‹œê°„: ${order.clean_time || "-"}<br>
${order.side_clean_time ? `ì‚¬ì´ì²­ì†Œ ì‹œê°„: ${order.side_clean_time}<br>` : ""}
  ${order.assigned_company ? `ë°°ì •ì—…ì²´: <b>${order.assigned_company}</b><br>` : ""}
</div>

    ${
      order.status === "ë°˜ë ¤ë¨" && order.memo
        ? `
        <div style="
          margin-top:8px;
          padding:8px;
          border-radius:8px;
          background:#fdecea;
          color:#c62828;
          font-size:12px;
          font-weight:600;
        ">
          ğŸ“Œ ë°˜ë ¤ ì‚¬ìœ : ${order.memo}
        </div>
        `
        : ""
    }

    <div style="margin-top:10px;">
      ${renderNextActionButtons(order)}
    </div>

    <div style="margin-top:6px;font-size:11px;color:#888;">
      ì ‘ìˆ˜ì¼: ${new Date(order.created_at).toLocaleString("ko-KR")}
    </div>
  </div>
`).join("");
}
  
  
let orderAutoRefreshTimer = null;

function showAdminTab(tab) {
  const box = document.getElementById("adminContent");
    // ì˜ˆì•½ ê´€ë¦¬ íƒ­ì´ ì•„ë‹ˆë©´ ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€
  if (tab !== "orders" && orderAutoRefreshTimer) {
    clearInterval(orderAutoRefreshTimer);
    orderAutoRefreshTimer = null;
  }
  /* ===============================
     ê³ ê° ê´€ë¦¬
     =============================== */
 if (tab === "customers") {
  box.innerHTML = `
    <h3>ğŸ‘¤ ê³ ê° ê´€ë¦¬</h3>
    <div id="customerList" style="margin-top:16px;"></div>
  `;

  loadCustomers();
  return;
}
  /* ===============================
     ì˜ˆì•½ ê´€ë¦¬
     =============================== */
if (tab === "orders") {
  box.innerHTML = `
    <h3>ğŸ“‹ ì˜ˆì•½ ê´€ë¦¬</h3>
    <div id="orderList" style="margin-top:16px;"></div>
  `;

  // ê¸°ì¡´ íƒ€ì´ë¨¸ ìˆìœ¼ë©´ ì œê±°
  if (orderAutoRefreshTimer) {
    clearInterval(orderAutoRefreshTimer);
    orderAutoRefreshTimer = null;
  }

  // ìµœì´ˆ 1íšŒ ë¡œë“œ
  loadOrders();


  orderAutoRefreshTimer = setInterval(() => {
    loadOrders();
  }, 5000);

  return;
}

  /* ===============================
     ì—…ì²´ ê´€ë¦¬
     =============================== */
 if (tab === "companies") {
  box.innerHTML = `
    <h3>ğŸ¢ ì—…ì²´ ê´€ë¦¬</h3>

    <div style="
      margin-top:12px;
      padding:16px;
      background:#fff;
      border-radius:12px;
      box-shadow:0 6px 18px rgba(0,0,0,0.06);
    ">
      <h4 style="margin-bottom:10px;">ì—…ì²´ ìƒì„±</h4>

      <input
        id="newCompanyName"
        placeholder="ì—…ì²´ëª…"
        style="width:100%;padding:10px;margin-bottom:8px;"
      />

      <label style="font-size:13px;">
        <input type="checkbox" id="newCompanyActive" checked />
        í™œì„±í™”
      </label>

      <button
        style="
          margin-top:12px;
          padding:10px 14px;
          border-radius:8px;
          border:none;
          background:#0288d1;
          color:#fff;
          font-weight:700;
          cursor:pointer;
        "
        onclick="createCompany()"
      >
        ì—…ì²´ ìƒì„±
      </button>
    </div>

    <div id="companyList" style="margin-top:16px;"></div>
  `;

  loadCompanies();
  return;
}
  async function createCompany() {
  const name = document.getElementById("newCompanyName").value.trim();
  const isActive = document.getElementById("newCompanyActive").checked;

  if (!name) {
    alert("ì—…ì²´ëª…ì„ ì…ë ¥í•˜ì„¸ìš”");
    return;
  }

  const { error } = await supabaseClient
    .from("companies")
    .insert([{ company_name: name, is_active: isActive }]);

  if (error) {
    console.error(error);
    alert("ì—…ì²´ ìƒì„± ì‹¤íŒ¨");
    return;
  }

  alert("ì—…ì²´ ìƒì„± ì™„ë£Œ");
  document.getElementById("newCompanyName").value = "";
  loadCompanies();
}
  async function loadCompanies() {
  const { data, error } = await supabaseClient
    .from("companies")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    console.error(error);
    alert("ì—…ì²´ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨");
    return;
  }

  const list = document.getElementById("companyList");
  if (!list) return;

  if (!data || data.length === 0) {
    list.innerHTML = "ë“±ë¡ëœ ì—…ì²´ ì—†ìŒ";
    return;
  }

  list.innerHTML = data.map(c => `
    <div style="
      background:#fff;
      border-radius:12px;
      padding:14px;
      margin-bottom:10px;
      box-shadow:0 4px 14px rgba(0,0,0,0.06);
    ">
      <b>${c.company_name}</b>
      <span style="
        margin-left:6px;
        font-size:11px;
        padding:2px 8px;
        border-radius:999px;
        background:${c.is_active ? "#e3f2fd" : "#fdecea"};
        color:${c.is_active ? "#1565c0" : "#c62828"};
      ">
        ${c.is_active ? "í™œì„±" : "ë¹„í™œì„±"}
      </span>

      <div style="margin-top:8px;">
        <button onclick="toggleCompanyActive('${c.id}', ${c.is_active})">
          ìƒíƒœ ë³€ê²½
        </button>
        <button onclick="deleteCompany('${c.id}')" style="color:#c62828;">
          ì‚­ì œ
        </button>
      </div>
    </div>
  `).join("");
}
async function toggleCompanyActive(id, current) {
  const { error } = await supabaseClient
    .from("companies")
    .update({ is_active: !current })
    .eq("id", id);

  if (error) {
    alert("ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨");
    return;
  }

  loadCompanies();
}
async function deleteCompany(id) {
  if (!confirm("ì´ ì—…ì²´ë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;

  const { error } = await supabaseClient
    .from("companies")
    .delete()
    .eq("id", id);

  if (error) {
    alert("ì‚­ì œ ì‹¤íŒ¨");
    return;
  }

  loadCompanies();
}

  
 /* ===============================
     ë¦¬ë·° ê´€ë¦¬
     =============================== */
if (tab === "reviews") {
  box.innerHTML = `
    <h3>â­ ë¦¬ë·° ê´€ë¦¬</h3>
    <div id="selectedOrderInfo"
     style="margin:6px 0;font-size:12px;color:#0288d1;font-weight:600;">
  ì„ íƒëœ ì£¼ë¬¸ ì—†ìŒ
</div>

    <div style="margin-top:12px;padding:12px;border:1px solid #ddd;border-radius:8px;">
      <h4>ë¦¬ë·° ì¶”ê°€</h4>

      <!-- ë§Œì¡±ë„ ë²„íŠ¼(3ê°œ) -->
      <div style="display:flex;gap:6px;margin-bottom:10px;">
        <button type="button" class="review-btn" onclick="selectAdminReviewScore(5)">ğŸ˜Š ë„ˆë¬´ ë§Œì¡±í•´ìš”</button>
        <button type="button" class="review-btn" onclick="selectAdminReviewScore(4)">ğŸ™‚ ë§Œì¡±í•´ìš”</button>
        <button type="button" class="review-btn" onclick="selectAdminReviewScore(2)">ğŸ˜ ì•„ì‰¬ì›Œìš”</button>
      </div>

      <input id="reviewAuthor" placeholder="ì‘ì„±ì(ì˜ˆ: ê¹€**)"
        style="width:100%;padding:8px;margin-bottom:6px;" />

      <textarea id="reviewText" placeholder="ë¦¬ë·° ë‚´ìš©"
        style="width:100%;padding:8px;height:80px;margin-bottom:6px;"></textarea>

      <!-- ğŸ“¸ ì‚¬ì§„ ì—…ë¡œë“œ -->
      <div style="margin:8px 0;">
        <div style="font-size:13px;font-weight:600;margin-bottom:4px;">
          í›„ê¸° ì‚¬ì§„ ì—…ë¡œë“œ (ìµœëŒ€ 10ì¥)
        </div>
        <input
          id="reviewPhotos"
          type="file"
          accept="image/*"
          multiple
          onchange="checkAdminReviewPhotos()"
        />
      </div>

      <button
  onclick="addReview()"
  id="addReviewBtn"
  disabled
>
  ë¦¬ë·° ì¶”ê°€
</button>
    </div>

    <div id="reviewList" style="margin-top:16px;"></div>
  `;

  loadAdminReviews();

  return;
}
}

function renderReviews() {
  const list = document.getElementById("reviewList");
  if (!list) return;

  list.innerHTML = adminReviews.map((r, i) => `
    <div style="border-bottom:1px solid #eee;padding:10px 0;">
      <strong>${"â˜…".repeat(r.star)}</strong><br/>
      <b>${r.author}</b><br/>
      <div style="font-size:13px;">${r.text}</div>

      ${
        r.photos && r.photos.length > 0
          ? `
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:6px;margin-top:6px;">
            ${r.photos.map(url => `
              <img src="${url}" style="width:100%;height:80px;object-fit:cover;border-radius:6px;" />
            `).join("")}
          </div>
          `
          : ""
      }

      <div style="margin-top:6px;">
        <button onclick="toggleReview(${i})">
          ${r.visible ? "ë…¸ì¶œì¤‘" : "ë¹„ë…¸ì¶œ"}
        </button>
        <button onclick="deleteReview(${i})">ì‚­ì œ</button>
      </div>
    </div>
  `).join("");
}
async function toggleReview(index) {
  const review = adminReviews[index];
  if (!review) return;

  const { error } = await supabaseClient
    .from("reviews")
    .update({ visible: !review.visible })
    .eq("id", review.id);

  if (error) {
    alert("ë…¸ì¶œ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨");
    console.error(error);
    return;
  }

  loadAdminReviews();
  loadPublicReviews();
}

async function deleteReview(index) {
  const review = adminReviews[index];
  if (!review) return;

  if (!confirm("ì´ ë¦¬ë·°ë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;

  const { error } = await supabaseClient
    .from("reviews")
    .delete()
    .eq("id", review.id);

  if (error) {
    alert("ë¦¬ë·° ì‚­ì œ ì‹¤íŒ¨");
    console.error(error);
    return;
  }

  loadAdminReviews();
  loadPublicReviews();
}  
    
async function uploadReviewPhotos(files) {
  const uploadedUrls = [];

  for (let i = 0; i < files.length; i++) {
    const file = files[i];

    const fileExt = file.name.split(".").pop();
    const fileName = `reviews/${crypto.randomUUID()}.${fileExt}`;

const { data, error } = await supabaseClient
  .storage
  .from("review-photos")
  .upload(fileName, file);

    if (error) {
      alert("ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨");
      console.error(error);
      return [];
    }

const { data: publicData } = supabaseClient
  .storage
  .from("review-photos")
  .getPublicUrl(fileName);

    uploadedUrls.push(publicData.publicUrl);
  }

  return uploadedUrls;
}
async function addReview() {
  // 1) ì£¼ë¬¸ ì„ íƒ í™•ì¸
  if (!window.selectedOrderId) {
    alert("í›„ê¸°ë¥¼ ì‘ì„±í•  ì£¼ë¬¸ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
    return;
  }

  // 2) ë§Œì¡±ë„ ì„ íƒ í™•ì¸
  if (!adminReviewScore) {
    alert("ë§Œì¡±ë„ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
    return;
  }

  // 3) ë™ì¼ ì£¼ë¬¸ ë¦¬ë·° ì¡´ì¬ ì—¬ë¶€ ì²´í¬ (í•µì‹¬!)
  const { data: exists, error: existsError } = await supabaseClient
    .from("reviews")
    .select("id")
    .eq("order_id", window.selectedOrderId)
    .maybeSingle();

  if (existsError) {
    console.error(existsError);
    alert("ë¦¬ë·° ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    return;
  }

  if (exists) {
    alert("ì´ ì£¼ë¬¸ì—ëŠ” ì´ë¯¸ í›„ê¸°ê°€ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.");
    return;
  }

  // 4) ì…ë ¥ê°’
  const author = document.getElementById("reviewAuthor").value.trim();
  const text = document.getElementById("reviewText").value.trim();
  const photoInput = document.getElementById("reviewPhotos");

  if (!author || !text) {
    alert("ì‘ì„±ìì™€ ë¦¬ë·° ë‚´ìš©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
    return;
  }

  // 5) ì‚¬ì§„ ì—…ë¡œë“œ
  let photoUrls = [];
  if (photoInput && photoInput.files.length > 0) {
    if (photoInput.files.length > 10) {
      alert("ì‚¬ì§„ì€ ìµœëŒ€ 10ì¥ê¹Œì§€ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
      return;
    }
    photoUrls = await uploadReviewPhotos(photoInput.files);
    if (!photoUrls || photoUrls.length === 0) {
      // ì—…ë¡œë“œ ì‹¤íŒ¨í•˜ë©´ ì¤‘ë‹¨
      return;
    }
  }

  // 6) DB ì €ì¥ (order_id ë³€ìˆ˜ ì ˆëŒ€ ì‹¤ìˆ˜ ê¸ˆì§€!)
  const { error } = await supabaseClient
    .from("reviews")
.insert([{
  order_id: window.selectedOrderId,
  author,
  text,
  star: adminReviewScore,
  photos: photoUrls,
  visible: true
}]);

  if (error) {
    console.error(error);
    alert("í›„ê¸° ì €ì¥ ì‹¤íŒ¨");
    return;
  }

  // 7) ì´ˆê¸°í™”
  adminReviewScore = null;
  document.getElementById("reviewAuthor").value = "";
  document.getElementById("reviewText").value = "";
  if (photoInput) photoInput.value = "";

  alert("í›„ê¸°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");

  loadAdminReviews();
  loadPublicReviews();
}

/* ===============================
   ê³ ê° í™”ë©´ ë¦¬ë·° ë Œë”ë§
   =============================== */
function renderPublicReviews() {
  const box = document.getElementById("publicReviewList");
  if (!box) return;

  box.innerHTML = publicReviews.map(r => `
    <div style="background:#fff;border-radius:16px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06);font-size:13px;">
      <div style="color:#f5a623;font-size:14px;margin-bottom:4px;">
        ${"â˜…".repeat(r.star)}
      </div>
     <div style="margin-bottom:6px;font-weight:600;">
  ${r.author || "ì‹¤ì œ ì´ìš© ê³ ê°"}
</div>
      <div style="color:#4b5665;">
        ${r.text}
      </div>

      ${
        r.photos && r.photos.length > 0
          ? `
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:6px;margin-top:10px;">
            ${r.photos.map(url => `
              <img src="${url}" style="width:100%;height:90px;object-fit:cover;border-radius:8px;" />
            `).join("")}
          </div>
          `
          : ""
      }

      <div style="margin-top:10px;font-size:11px;color:#8a94a6;">
        í´ë¦°ë©”ì´íŠ¸ ì‹¤ì œ ì´ìš© ê³ ê° í›„ê¸°
      </div>
    </div>
  `).join("");
}
function renderBAGallery() {
  const box = document.getElementById("baGallery");
  if (!box) return;

  box.innerHTML = publicReviews
    .filter(r => r.visible && r.photos && r.photos.length > 0)
    .flatMap(r => r.photos)
    .map(url => `
      <div class="ba-card">
        <img src="${url}" />
        <div class="ba-card-footer">
          <span>ì‹¤ì œ ê³ ê° ì‘ì—…</span>
          <span class="tag">í›„ê¸° ê¸°ë°˜</span>
        </div>
      </div>
    `)
    .join("");
}
document.addEventListener("DOMContentLoaded", () => {
  loadPublicReviews();
});

function renderCustomers() {
  const list = document.getElementById("customerList");
  if (!list) return;

  list.innerHTML = customers.map((c, i) => `
    <div style="
      background:#fff;
      border-radius:12px;
      padding:14px;
      margin-bottom:12px;
      box-shadow:0 6px 18px rgba(0,0,0,0.06);
    ">
      <div style="font-weight:700;">
        ${c.name}
        <span style="color:#666;font-size:12px;">
          (${c.phone})
        </span>
      </div>

      <div style="font-size:13px;color:#555;margin-top:4px;">
        ì£¼ì†Œ: ${c.address}<br>
        ì´ìš© íšŸìˆ˜: <b>${c.count}íšŒ</b>
      </div>

<textarea
  style="
    width:100%;
    margin-top:8px;
    border-radius:8px;
    border:1px solid #ddd;
    padding:8px;
    font-size:12px;
  "
  placeholder="ê´€ë¦¬ì ë©”ëª¨"
  onchange="customers[${i}].memo = this.value"
>${c.memo}</textarea>

<button
  style="
    margin-top:8px;
    padding:6px 10px;
    border:1px solid #ddd;
    border-radius:6px;
    background:#fff;
    cursor:pointer;
    font-size:12px;
  "
  onclick="deleteCustomer(${i})"
>
  ğŸ—‘ ê³ ê° ì‚­ì œ
</button>
    </div>
  `).join("");
}
function deleteCustomer(i) {
  if (confirm("ì´ ê³ ê° ì •ë³´ë¥¼ ì‚­ì œí• ê¹Œìš”?")) {
    customers.splice(i, 1);
    renderCustomers();
  }
}

</script>
