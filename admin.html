<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>CleanMate ê´€ë¦¬ì</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body{
      margin:0;
      padding:20px;
      font-family:-apple-system, BlinkMacSystemFont, "Noto Sans KR", system-ui;
      background:#f5f7fb;
    }
    h2,h3{margin:0}
    button{
      padding:8px 14px;
      border-radius:8px;
      border:1px solid #ccc;
      background:#fff;
      cursor:pointer;
      font-weight:600;
    }
    .card{
      background:#fff;
      border-radius:14px;
      padding:14px;
      box-shadow:0 6px 18px rgba(0,0,0,0.06);
      margin-bottom:12px;
    }
  </style>
</head>

<body>

<!-- ===============================
 ê´€ë¦¬ì ë¡œê·¸ì¸
 =============================== -->
<div id="loginBox" class="card" style="max-width:360px;margin:120px auto;">
  <h3 style="text-align:center;margin-bottom:12px;">CleanMate ê´€ë¦¬ì ë¡œê·¸ì¸</h3>

  <input id="adminId" placeholder="ì•„ì´ë””"
    style="width:100%;padding:10px;margin-bottom:8px;" />

  <input id="adminPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸"
    style="width:100%;padding:10px;margin-bottom:12px;" />

  <button style="width:100%;" onclick="adminLogin()">ë¡œê·¸ì¸</button>
</div>

<!-- ===============================
 ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ
 =============================== -->
<div id="dashboard" style="display:none;max-width:1200px;margin:0 auto;">

  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
    <div>
      <h2>CleanMate ê´€ë¦¬ì</h2>
      <div style="font-size:12px;color:#666;">ê²¬ì  Â· ì£¼ë¬¸ Â· ì—…ì²´ Â· ë¦¬ë·° ê´€ë¦¬</div>
    </div>
    <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <!-- í†µê³„ -->
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:20px;">
    <div class="card"><b>ëˆ„ì  ê²¬ì </b><br><span id="statOrders">-</span></div>
    <div class="card"><b>ê³ ê° ìˆ˜</b><br><span id="statCustomers">-</span></div>
    <div class="card"><b>ë°°ì • ì™„ë£Œ</b><br><span id="statAssigned">-</span></div>
    <div class="card"><b>í‰ê·  ê°ë‹¨ê°€</b><br><span id="statAvg">-</span></div>
  </div>

  <!-- íƒ­ -->
  <div style="display:flex;gap:10px;margin-bottom:14px;">
    <button onclick="showTab('orders')">ğŸ“‹ ì˜ˆì•½</button>
    <button onclick="showTab('companies')">ğŸ¢ ì—…ì²´</button>
    <button onclick="showTab('reviews')">â­ ë¦¬ë·°</button>
  </div>

  <div id="content"></div>
</div>

<script>
/* ===============================
 Supabase
 =============================== */
const SUPABASE_URL = "https://nuchpyxjyqcpldpnffhu.supabase.co";
const SUPABASE_KEY = "sb_publishable_edX6Oi2eo5A5MjYYo323Fg_6ESnzQmL";

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_KEY
);

/* ===============================
 ë¡œê·¸ì¸
 =============================== */
function adminLogin(){
  const id = document.getElementById("adminId").value;
  const pw = document.getElementById("adminPw").value;

  if(id === "clean8904" && pw === "ghkstmdzmffls8904!"){
    sessionStorage.setItem("admin", "true");
    openDashboard();
  } else {
    alert("ë¡œê·¸ì¸ ì‹¤íŒ¨");
  }
}

function openDashboard(){
  document.getElementById("loginBox").style.display="none";
  document.getElementById("dashboard").style.display="block";
  loadStats();
  showTab("orders");
}

function logout(){
  sessionStorage.clear();
  location.reload();
}

/* ===============================
 í†µê³„
 =============================== */
async function loadStats(){
  const { count: orders } = await supabaseClient
    .from("orders").select("*",{count:"exact",head:true});
  const { count: customers } = await supabaseClient
    .from("customers").select("*",{count:"exact",head:true});
  const { count: assigned } = await supabaseClient
    .from("orders").select("*",{count:"exact",head:true}).eq("status","ë°°ì •ì™„ë£Œ");

  const { data: prices } = await supabaseClient
    .from("orders").select("estimated_price_number").not("estimated_price_number","is",null);

  let avg="-";
  if(prices && prices.length){
    avg = Math.round(
      prices.reduce((a,b)=>a+b.estimated_price_number,0)/prices.length
    ).toLocaleString();
  }

  statOrders.textContent = orders ?? "-";
  statCustomers.textContent = customers ?? "-";
  statAssigned.textContent = assigned ?? "-";
  statAvg.textContent = avg;
}

/* ===============================
 íƒ­
 =============================== */
function showTab(tab){
  if(tab==="orders") loadOrders();
  if(tab==="companies") loadCompanies();
  if(tab==="reviews") loadReviews();
}

/* ===============================
 ì˜ˆì•½ ê´€ë¦¬
 =============================== */
async function loadOrders(){
  const { data } = await supabaseClient
    .from("orders")
    .select("*")
    .order("created_at",{ascending:false});

  content.innerHTML = `
    <h3>ğŸ“‹ ì˜ˆì•½ ê´€ë¦¬</h3>
    ${data.map(o=>`
      <div class="card">
        <b>${o.name}</b> (${o.phone})<br>
        ìƒíƒœ: <b>${o.status}</b><br>
        ${o.assigned_company?`ì—…ì²´: ${o.assigned_company}<br>`:""}
        <button onclick="assign('${o.id}')">ë°°ì •</button>
        <button onclick="reject('${o.id}')">ë°˜ë ¤</button>
      </div>
    `).join("")}
  `;
}

async function assign(id){
  const { data: c } = await supabaseClient
    .from("companies")
    .select("company_name")
    .eq("is_active",true)
    .limit(1)
    .single();

  if(!c){ alert("í™œì„± ì—…ì²´ ì—†ìŒ"); return; }

  await supabaseClient
    .from("orders")
    .update({status:"ë°°ì •ì™„ë£Œ",assigned_company:c.company_name})
    .eq("id",id);

  loadOrders();
}

async function reject(id){
  await supabaseClient
    .from("orders")
    .update({status:"ë°˜ë ¤ë¨"})
    .eq("id",id);
  loadOrders();
}

/* ===============================
 ì—…ì²´ ê´€ë¦¬
 =============================== */
async function loadCompanies(){
  const { data } = await supabaseClient.from("companies").select("*");

  content.innerHTML = `
    <h3>ğŸ¢ ì—…ì²´ ê´€ë¦¬</h3>
    <div class="card">
      <input id="cname" placeholder="ì—…ì²´ëª…" style="width:100%;padding:8px;" />
      <button onclick="createCompany()">ì—…ì²´ ìƒì„±</button>
    </div>
    ${data.map(c=>`
      <div class="card">
        <b>${c.company_name}</b> (${c.is_active?"í™œì„±":"ë¹„í™œì„±"})
        <button onclick="toggle('${c.id}',${c.is_active})">ìƒíƒœ</button>
      </div>
    `).join("")}
  `;
}

async function createCompany(){
  const name=document.getElementById("cname").value.trim();
  if(!name) return alert("ì—…ì²´ëª…");
  await supabaseClient.from("companies").insert({company_name:name,is_active:true});
  loadCompanies();
}

async function toggle(id,cur){
  await supabaseClient.from("companies").update({is_active:!cur}).eq("id",id);
  loadCompanies();
}

/* ===============================
 ë¦¬ë·° ê´€ë¦¬ (ì¡°íšŒë§Œ)
 =============================== */
async function loadReviews(){
  const { data } = await supabaseClient.from("reviews").select("*");
  content.innerHTML = `
    <h3>â­ ë¦¬ë·° ê´€ë¦¬</h3>
    ${data.map(r=>`
      <div class="card">
        ${"â˜…".repeat(r.star)}<br>
        ${r.author}<br>
        ${r.text}
      </div>
    `).join("")}
  `;
}

/* ===============================
 ìë™ ë¡œê·¸ì¸ ìœ ì§€
 =============================== */
if(sessionStorage.getItem("admin")==="true"){
  openDashboard();
}
</script>

</body>
</html>
